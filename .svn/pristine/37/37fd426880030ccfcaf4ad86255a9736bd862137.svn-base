//
//  UserWeightViewController.m
//  Demo
//
//  Created by Ares on 14/10/28.
//  Copyright (c) 2014年 Ares. All rights reserved.
//

#import "UserWeightViewController.h"

#import "IZValueSelectorView.h"

#import <QuartzCore/QuartzCore.h>
//#import "SetUserInfoManager.h"

// test by ares
@interface UserWeightViewController () <IZValueSelectorViewDataSource, IZValueSelectorViewDelegate>
{
    UISwipeGestureRecognizer *leftSwipeGestureRecognizer;
    UISwipeGestureRecognizer *rightSwipeGestureRecognizer;
    BOOL isFirstCome_;
    NSString *weightStr_;
}

// weight picker view
@property (nonatomic, retain) IBOutlet IZValueSelectorView *weightPickerView;

// weight plate indicator
@property (nonatomic, retain) IBOutlet UIImageView *weightPlateIndicator;

@end

@implementation UserWeightViewController

@synthesize weightPickerView = _weightPickerView;

@synthesize weightPlateIndicator = _weightPlateIndicator;

- (instancetype)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil {
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // set its view background color if needed
        if (!nibNameOrNil) {
            self.view.backgroundColor = [UIColor whiteColor];
        }
    }
    return self;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    // set user weight picker view as horizontal, set its data source and delegate
    _weightPickerView.horizontalScrolling = YES;
    [_weightPickerView setDataSource:self];
    [_weightPickerView setDelegate:self];
    
//    if (![NFUserEntity shareInstance].userWeight || [NFUserEntity shareInstance].userWeight.length == 0)
//    {
//        [NFUserEntity shareInstance].userWeight = @"81";
        weightStr_ = @"81";
//    }
    
    if (_isFromSet)
    {
        self.title = @"修改体重";
        [self setNavBarButton];
    }
    else
    {
        self.title = @"设置体重";
        [self setNavBarButton];
        leftSwipeGestureRecognizer = [[UISwipeGestureRecognizer alloc] initWithTarget:self action:@selector(handleSwipes:)];
        rightSwipeGestureRecognizer = [[UISwipeGestureRecognizer alloc] initWithTarget:self action:@selector(handleSwipes:)];
        
        leftSwipeGestureRecognizer.direction = UISwipeGestureRecognizerDirectionLeft;
        rightSwipeGestureRecognizer.direction = UISwipeGestureRecognizerDirectionRight;
        
        [self.view addGestureRecognizer:leftSwipeGestureRecognizer];
        [self.view addGestureRecognizer:rightSwipeGestureRecognizer];
    }
}

- (void)handleSwipes:(UISwipeGestureRecognizer *)sender
{
    if (sender.direction == UISwipeGestureRecognizerDirectionRight)
    {
        [self.navigationController popViewControllerAnimated:YES];
    }
}

- (void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];
    
    if (_isFromSet)
    {
        self.navigationController.navigationBar.alpha = 0.6;
    }
    else
    {
        self.navigationController.navigationBar.alpha = 0.6;
        self.navigationController.navigationBarHidden = NO;
    }
}

- (void)viewWillDisappear:(BOOL)animated
{
    [super viewWillDisappear:animated];
    
    if (_isFromSet)
    {
        self.navigationController.navigationBar.alpha = 1.0;
    }
    else
    {
        self.navigationController.navigationBar.alpha = 1.0;
        self.navigationController.navigationBarHidden = YES;
    }
}

- (void)viewDidAppear:(BOOL)animated {
    [super viewDidAppear:animated];
    
    if (!_isFromSet)
    {
    }
    
//    if (!isFirstCome_)
//    {
        // set the weight weight plate indicator anchor point
        _weightPlateIndicator.layer.anchorPoint = CGPointMake(0.5f, 0.88f);
        
        // update the weight weight plate indicator center because its anchor point been set
        if (NSFoundationVersionNumber_iOS_7_1 < NSFoundationVersionNumber) {
            _weightPlateIndicator.center = CGPointMake(_weightPlateIndicator.center.x, _weightPlateIndicator.center.y + (0.88 - 0.5) * _weightPlateIndicator.bounds.size.height);
        }
        else {
            // ios 7 and early bug?
            _weightPlateIndicator.layer.anchorPoint = CGPointMake(0.5f, 0.55f);
        }
        
        isFirstCome_ = YES;
//    }
    
    // set its default picker value
//    [_weightPickerView selectRow:[[NFUserEntity shareInstance].userWeight integerValue] - 30 animated:NO];
//    [(id<IZValueSelectorViewDelegate>)_weightPickerView.delegate selector:_weightPickerView didSelectRowAtIndex:[[NFUserEntity shareInstance].userWeight integerValue] - 30];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

// test by ares
#pragma mark - IZ value selector data source

- (NSInteger)numberOfRowsInSelector:(IZValueSelectorView *)valueSelector {
    //
    return 101;
}

- (CGFloat)rowHeightInSelector:(IZValueSelectorView *)valueSelector {
    return 0;
}

- (CGFloat)rowWidthInSelector:(IZValueSelectorView *)valueSelector {
    //
    return 90.0f;
}

- (UIView *)selector:(IZValueSelectorView *)valueSelector viewForRowAtIndex:(NSInteger)index {
    UILabel *_rowView = [[UILabel alloc] initWithFrame:CGRectMake(0, 0, 90.0f, _weightPickerView.frame.size.height)];
    
    // set the row label view background color clear
    [_rowView setBackgroundColor:[UIColor clearColor]];
    
    // set row view text, text size, text color and text alignment
    [_rowView setText:[NSString stringWithFormat:@"%@", @(30 + index)]];
    [_rowView setTextColor:NFBlueColor];
    [_rowView setFont:[UIFont boldSystemFontOfSize:49.0f]];
    [_rowView setTextAlignment:NSTextAlignmentCenter];
    
    return _rowView;
}

- (CGRect)rectForSelectionInSelector:(IZValueSelectorView *)valueSelector {
    //
    return CGRectMake((_weightPickerView.frame.size.width - 90.0f) / 2, 0, 90.0f, _weightPickerView.frame.size.height);
    
}

#pragma mark - IZ value selector delegate

- (void)selector:(IZValueSelectorView *)valueSelector didSelectRowAtIndex:(NSInteger)index {
    
    if (!_isFromSet)
    {
//        [NFUserEntity shareInstance].userWeight = [NSString stringWithFormat:@"%@",@(30 + index)];
        weightStr_ = [NSString stringWithFormat:@"%@",@(30 + index)];
    }
    else
    {
        weightStr_ = [NSString stringWithFormat:@"%@",@(30 + index)];
    }
    
//    DLog(@"%@",[NFUserEntity shareInstance].userWeight);
    // get weight changed rotation step
    CGFloat _step = 138.0f / (130 - 30);
    
    // begin the weight changed rotation animation
    [UIView beginAnimations:@"weightChangedRotationAnim" context:nil];
    
    // set animation duration and curver
    [UIView setAnimationDuration:0.45f];
    [UIView setAnimationCurve:UIViewAnimationCurveEaseOut];
    
    // change weight plate indicator rotate degree
    _weightPlateIndicator.transform = CGAffineTransformMakeRotation(_step * (index - 100 / 2) * (M_PI / 180.0f));
    
    // commit the animation
    [UIView commitAnimations];
}

#pragma mark - 右侧保存

- (void)setNavBarButton
{
    // 设置 navigation bar 右侧按钮
    UIButton * leftBtn = [[UIButton alloc]initWithFrame:CGRectMake(0, 0, 50, 27)];
    leftBtn.titleLabel.textAlignment = NSTextAlignmentLeft;
    
    [leftBtn setTitle:@"保存" forState:UIControlStateNormal];
    [leftBtn addTarget:self action:@selector(handleRightBtn) forControlEvents:UIControlEventTouchUpInside];
    [leftBtn setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
    leftBtn.titleLabel.font = [UIFont systemFontOfSize:14.0];
    ViewRadius(leftBtn, 2);
    
    UIBarButtonItem *leftButtonItem = [[UIBarButtonItem alloc] initWithCustomView:leftBtn];
    self.navigationItem.rightBarButtonItem = leftButtonItem;
}

- (void)handleRightBtn
{
//    SetUserInfoManager *setUserInfo_ = [[SetUserInfoManager alloc] init];
//    if (_isFromSet) {
//        [setUserInfo_ setUserInfoWithType:SetStringTypeWeight withInfo:weightStr_ result:^(BOOL success, NSString *wrongStr) {
//            if (success)
//            {
//                [NFUserEntity shareInstance].userWeight = weightStr_;
//                [KeepAppBox keepVale:[NFUserEntity shareInstance].userWeight forKey:@"weight"];
    
    NSUserDefaults *defaultGet  = [NSUserDefaults standardUserDefaults];
    [defaultGet setObject:weightStr_ forKey:@"weightStr_"];
    [self.navigationController popViewControllerAnimated:YES];
    
//            }
//            else
//            {
//                [SVProgressHUD showErrorWithStatus:wrongStr];
//            }
//        }];
//    }
//    else
//    {
//        [NFUserEntity shareInstance].userWeight = weightStr_;
//        [KeepAppBox keepVale:[NFUserEntity shareInstance].userWeight forKey:@"weight"];
//        [self.navigationController popViewControllerAnimated:YES];
//    }
    
}

@end
